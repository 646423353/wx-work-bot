# 企业微信消息监控助手 - 部署与监控指南

## 目录

1. [系统架构](#系统架构)
2. [环境要求](#环境要求)
3. [安装部署](#安装部署)
4. [企业微信接入配置](#企业微信接入配置)
5. [系统配置](#系统配置)
6. [启动运行](#启动运行)
7. [监控功能使用](#监控功能使用)
8. [常见问题排查](#常见问题排查)
9. [维护与升级](#维护与升级)

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      企业微信服务器                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  企业微信   │───▶│   消息推送  │───▶│  回调接口   │     │
│  │   客户端   │    │   服务器    │    │             │     │
│  └─────────────┘    └─────────────┘    └──────┬──────┘     │
└─────────────────────────────────────────────────┼───────────┘
                                                  │
                                                  ▼
┌─────────────────────────────────────────────────────────────┐
│                   消息监控助手系统                           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │  消息接收   │───▶│  消息处理   │───▶│  告警判断   │     │
│  │   服务     │    │   引擎      │    │   引擎      │     │
│  └─────────────┘    └─────────────┘    └──────┬──────┘     │
│                                               │             │
│  ┌─────────────┐    ┌─────────────┐          │             │
│  │  Web管理   │◀───│  数据存储   │◀─────────┘             │
│  │   界面     │    │  (SQLite)   │                        │
│  └─────────────┘    └─────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件

- **消息接收服务**: 接收企业微信推送的消息
- **消息处理引擎**: 解析和存储消息数据
- **告警判断引擎**: 检测未回复消息并触发告警
- **Web管理界面**: Vue3 + Element Plus 构建的管理后台
- **数据存储**: SQLite 轻量级数据库

---

## 环境要求

### 服务器要求

| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核及以上 |
| 内存 | 4GB | 8GB及以上 |
| 硬盘 | 20GB | 50GB及以上 |
| 网络 | 公网IP，可访问互联网 | 固定公网IP |
| 操作系统 | Windows 10/Server 2016+ | Windows Server 2019/2022 |

### 软件依赖

- Node.js >= 18.0.0
- npm >= 9.0.0
- Git (可选，用于版本管理)

---

## 安装部署

### 1. 下载项目代码

```bash
# 克隆项目到本地
git clone <项目仓库地址> wx-work-bot
cd wx-work-bot

# 或者直接下载解压后进入目录
cd wx-work-bot
```

### 2. 安装后端依赖

```bash
# 在项目根目录安装后端依赖
npm install

# 安装企业微信官方加密库（必需，用于消息加解密）
npm install @wecom/crypto xml2js
```

### 3. 安装前端依赖

```bash
# 进入前端目录
cd frontend

# 安装前端依赖
npm install

# 返回项目根目录
cd ..
```

### 4. 环境变量配置

在项目根目录创建 `.env` 文件：

```env
# 服务器配置
PORT=3000
NODE_ENV=production

# 企业微信配置（必填）
CORP_ID=your_corp_id_here                    # 企业ID，在「我的企业」页面获取
CORP_SECRET=your_corp_secret_here            # 应用Secret，在应用详情页获取
AGENT_ID=your_agent_id_here                  # 应用AgentId，在应用详情页获取
ENCODING_AES_KEY=your_encoding_aes_key_here  # 消息加密密钥，在「接收消息」配置时生成
TOKEN=your_token_here                        # 回调验证Token，自定义随机字符串

# 回调URL配置（需要替换为你的公网地址）
WEBHOOK_URL=https://your-domain.com/api/webhook

# JWT密钥（用于用户认证，请生成随机字符串）
JWT_SECRET=your_random_jwt_secret_key_here

# 管理员账号（首次登录使用）
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
```

**配置说明：**
- `CORP_ID`: 登录企业微信管理后台，在「我的企业」页面底部获取
- `CORP_SECRET`: 在「应用管理」→应用详情页，点击「查看」获取
- `AGENT_ID`: 在应用详情页查看
- `ENCODING_AES_KEY`: 在应用「接收消息」→「设置API」时随机生成，或手动填写43位随机字符
- `TOKEN`: 自定义的随机字符串，用于验证回调URL，建议16-32位随机字符

### 5. 数据库初始化

```bash
# 启动服务会自动创建数据库
node index.js

# 或者手动初始化
node scripts/init-db.js
```

---

## 企业微信接入配置

### 1. 创建企业微信应用

1. 登录 [企业微信管理后台](https://work.weixin.qq.com/wework_admin)
2. 进入「应用管理」→「自建应用」→「创建应用」
3. 填写应用信息：
   - 应用名称：消息监控助手
   - 应用Logo：上传应用图标
   - 可见范围：选择需要监控的部门

### 2. 获取应用凭证

在应用详情页面获取：
- **AgentId**: 应用的唯一标识
- **Secret**: 应用的密钥（点击「查看」获取）

### 3. 配置接收消息（关键步骤）

1. 在应用详情页，点击「接收消息」→「设置API」
2. 填写回调配置：
   - **URL**: `http://your-server-ip:3000/api/webhook`
     - 必须是公网可访问的地址
     - 确保端口3000已开放
     - 支持HTTP或HTTPS（生产环境建议HTTPS）
   - **Token**: 自定义随机字符串（与.env中TOKEN一致）
     - 建议16-32位随机字符
     - 用于验证回调URL的合法性
   - **EncodingAESKey**: 点击「随机生成」或手动填写43位字符
     - 用于消息内容的加密解密
     - 必须与.env中ENCODING_AES_KEY一致

3. 点击「保存」，企业微信会发送验证请求到你的服务器
   - 服务器会收到GET请求，包含`echostr`参数
   - 服务器需要解密`echostr`并原样返回
   - 验证通过后，企业微信会推送消息到该URL

**验证失败排查：**
- 检查服务器是否可以访问互联网
- 确认防火墙已开放3000端口
- 检查`.env`中的TOKEN和ENCODING_AES_KEY与后台配置一致
- 查看服务器日志：`pm2 logs wx-work-bot`

### 4. 配置IP白名单

1. 进入「应用管理」→「应用详情」
2. 找到「企业可信IP」，添加你的服务器公网IP
3. 确保服务器IP可以访问企业微信API

### 5. 获取企业ID

1. 进入「我的企业」页面
2. 复制页面底部的「企业ID」
3. 填入 `.env` 文件的 `CORP_ID`

### 6. 配置群聊机器人（可选）

如需在群聊中接收告警：

1. 在目标群聊中，点击右上角「...」→「添加群机器人」
2. 创建机器人，获取 **Webhook地址**
3. 在系统设置中配置告警通知方式

---

## 系统配置

### 1. 配置文件说明

主要配置文件位于项目根目录：

```
wx-work-bot/
├── .env                    # 环境变量配置
├── config/
│   └── default.js          # 默认配置
├── data/
│   └── wxwork.db          # SQLite数据库
└── logs/
    └── app.log            # 应用日志
```

### 2. 告警规则配置

登录Web管理界面后，进入「告警配置」页面：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 超时时间 | 消息未回复的超时阈值（分钟） | 30 |
| 启用告警 | 是否开启告警功能 | 开启 |
| 通知方式 | 邮件/短信/微信通知 | 邮件+微信 |
| 敏感词 | 需要监控的关键词列表 | 空 |

### 3. 监控群聊配置

进入「群聊管理」页面：

1. 点击「添加群聊」
2. 输入群聊ID（从企业微信获取）
3. 设置群聊名称和监控规则
4. 指定责任人（未回复时通知）

---

## 启动运行

### 1. 开发环境启动

```bash
# 启动后端服务（项目根目录）
npm run dev

# 启动前端开发服务器（新开终端）
cd frontend
npm run dev
```

### 2. 生产环境部署

#### 构建前端

```bash
cd frontend
npm run build
```

#### 使用PM2启动（推荐）

```bash
# 全局安装PM2
npm install -g pm2

# 创建PM2配置文件
echo '{
  "apps": [{
    "name": "wx-work-bot",
    "script": "./index.js",
    "instances": 1,
    "autorestart": true,
    "watch": false,
    "max_memory_restart": "1G",
    "env": {
      "NODE_ENV": "production"
    },
    "log_date_format": "YYYY-MM-DD HH:mm:ss",
    "error_file": "./logs/err.log",
    "out_file": "./logs/out.log"
  }]
}' > ecosystem.json

# 启动服务
pm2 start ecosystem.json

# 保存PM2配置
pm2 save
pm2 startup
```

#### 使用Windows服务启动

```powershell
# 安装node-windows
npm install -g node-windows

# 创建服务
npx node-windows install

# 启动服务
net start wx-work-bot
```

### 3. 访问系统

- **Web管理界面**: `http://localhost:5173` (开发) 或 `http://your-server-ip` (生产)
- **默认账号**: admin / admin123
- **API接口**: `http://localhost:3000/api`

---

## 监控功能使用

### 1. 监控仪表盘

登录后进入首页，可查看：

- **监控群聊数**: 当前监控的群聊总数
- **今日消息总数**: 当天接收的所有消息数量
- **未回复消息**: 超过超时时间未回复的消息数
- **平均响应时间**: 客服平均回复时长

### 2. 群聊状态监控

在「群聊管理」页面：

- 查看各群聊的消息统计
- 标记未回复消息
- 查看平均响应时间
- 识别异常群聊（响应慢、消息堆积）

### 3. 告警处理

当系统检测到未回复消息时：

1. **Web界面告警**: 在「未回复告警」区域显示红色警告
2. **即时提醒**: 点击铃铛图标发送提醒给责任人
3. **消息推送**: 通过企业微信发送告警消息

### 4. 数据报表

进入「数据报表」页面可查看：

- 消息总量统计
- 各群聊消息分布
- 回复率分析
- 响应时间趋势
- 导出Excel报表

---

## 常见问题排查

### 1. 企业微信回调验证失败

**问题**: 配置回调URL时提示验证失败

**排查步骤**:
1. 检查服务器是否可以访问互联网
   ```bash
   curl https://work.weixin.qq.com
   ```

2. 确认防火墙已开放3000端口
   ```bash
   # Linux
   sudo firewall-cmd --list-ports
   sudo firewall-cmd --add-port=3000/tcp --permanent
   sudo firewall-cmd --reload
   
   # 或使用iptables
   sudo iptables -I INPUT -p tcp --dport 3000 -j ACCEPT
   ```

3. 验证 `.env` 中的配置与后台一致
   - `CORP_ID`: 企业ID
   - `TOKEN`: 回调Token
   - `ENCODING_AES_KEY`: 消息加密密钥（43位）

4. 检查是否安装了加密库
   ```bash
   npm list @wecom/crypto
   # 如未安装，执行：
   npm install @wecom/crypto xml2js
   ```

5. 查看后端日志排查具体错误
   ```bash
   # PM2方式
   pm2 logs wx-work-bot
   
   # 或直接运行查看
   node index.js
   ```

**常见错误及解决：**
- **错误：404 Not Found** → 检查URL路径是否为 `/api/webhook`
- **错误：解密失败** → 检查ENCODING_AES_KEY是否正确（43位）
- **错误：签名验证失败** → 检查TOKEN是否一致
- **错误：超时** → 检查服务器防火墙和端口开放情况

### 2. 收不到企业微信消息

**问题**: 系统启动正常但收不到消息推送

**排查步骤**:
1. 确认企业微信应用已启用
2. 检查IP白名单是否包含服务器IP
3. 验证回调URL配置正确
4. 检查后端服务是否正常运行

### 3. 告警通知未发送

**问题**: 有未回复消息但没有收到通知

**排查步骤**:
1. 检查「告警配置」是否启用
2. 确认超时时间设置合理
3. 验证通知方式配置正确
4. 查看群聊是否已设置责任人

### 4. 前端页面无法访问

**问题**: 浏览器无法打开管理界面

**排查步骤**:
1. 确认前端服务已启动
2. 检查端口是否被占用：`netstat -ano | findstr 5173`
3. 查看浏览器控制台是否有报错
4. 清除浏览器缓存后重试

### 5. 数据库连接错误

**问题**: 提示SQLite数据库错误

**解决方案**:
```bash
# 检查data目录是否存在
mkdir -p data

# 修复数据库权限
chmod 755 data

# 重新初始化数据库
rm data/wxwork.db
node scripts/init-db.js
```

---

## 维护与升级

### 1. 日常维护

#### 查看服务状态
```bash
# PM2方式
pm2 status
pm2 logs wx-work-bot

# Windows服务方式
net start | findstr wx-work-bot
```

#### 备份数据
```bash
# 备份数据库
cp data/wxwork.db backup/wxwork_$(date +%Y%m%d).db

# 备份配置
cp .env backup/env_$(date +%Y%m%d)
```

#### 清理日志
```bash
# 日志轮转
pm2 logrotate

# 手动清理
rm logs/*.log
pm2 reload wx-work-bot
```

### 2. 系统升级

#### 更新代码
```bash
# 拉取最新代码
git pull origin main

# 安装新依赖
npm install
cd frontend && npm install && cd ..

# 重新构建前端
cd frontend
npm run build
cd ..
```

#### 数据库迁移
```bash
# 执行迁移脚本
node scripts/migrate.js
```

#### 重启服务
```bash
# PM2方式
pm2 reload wx-work-bot

# 或完全重启
pm2 restart wx-work-bot
```

### 3. 性能优化

#### 数据库优化
```sql
-- 定期清理旧数据（保留90天）
DELETE FROM messages WHERE created_at < datetime('now', '-90 days');
VACUUM;
```

#### 系统参数调优
编辑 `config/default.js`:

```javascript
module.exports = {
  // 消息处理并发数
  messageConcurrency: 10,
  
  // 数据库连接池
  dbPool: {
    max: 10,
    min: 2
  },
  
  // 缓存配置
  cache: {
    ttl: 300, // 5分钟
    max: 1000
  }
}
```

---

## 安全建议

1. **修改默认密码**: 首次登录后立即修改admin密码
2. **启用HTTPS**: 生产环境配置SSL证书
3. **限制访问IP**: 配置防火墙只允许特定IP访问管理界面
4. **定期备份**: 设置定时任务自动备份数据库
5. **日志审计**: 定期检查日志文件，发现异常及时处理

---

## 技术支持

如遇到问题，可通过以下方式获取帮助：

1. 查看项目文档：`doc/` 目录
2. 查看系统日志：`logs/` 目录
3. 提交Issue到项目仓库
4. 联系开发团队

---

## 附录

### A. 环境变量完整列表

| 变量名 | 必填 | 说明 |
|--------|------|------|
| PORT | 否 | 服务端口号，默认3000 |
| NODE_ENV | 否 | 运行环境，development/production |
| CORP_ID | 是 | 企业微信企业ID |
| CORP_SECRET | 是 | 企业微信应用Secret |
| AGENT_ID | 是 | 企业微信应用AgentId |
| ENCODING_AES_KEY | 是 | 消息加密密钥 |
| TOKEN | 是 | 回调验证Token |
| WEBHOOK_URL | 是 | 回调URL地址 |
| JWT_SECRET | 是 | JWT签名密钥 |
| ADMIN_USERNAME | 否 | 管理员账号，默认admin |
| ADMIN_PASSWORD | 否 | 管理员密码，默认admin123 |

### B. API接口列表

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/auth/login | POST | 用户登录 |
| /api/auth/logout | POST | 用户登出 |
| /api/webhook | POST | 接收企业微信消息 |
| /api/groups | GET/POST | 群聊管理 |
| /api/messages | GET | 消息查询 |
| /api/alerts | GET/PUT | 告警配置 |
| /api/reports | GET | 数据报表 |
| /api/settings | GET/PUT | 系统设置 |

### C. 目录结构

```
wx-work-bot/
├── backend/               # 后端源码
│   ├── routes/           # API路由
│   ├── services/         # 业务逻辑
│   ├── models/           # 数据模型
│   └── utils/            # 工具函数
├── frontend/             # 前端源码
│   ├── src/
│   │   ├── views/        # 页面组件
│   │   ├── components/   # 公共组件
│   │   ├── stores/       # Pinia状态管理
│   │   └── api/          # API接口
│   └── dist/             # 构建输出
├── data/                 # 数据库文件
├── logs/                 # 日志文件
├── doc/                  # 项目文档
├── config/               # 配置文件
├── index.js              # 后端入口
└── package.json          # 项目依赖
```

---

**文档版本**: v1.0  
**更新日期**: 2026-01-28  
**适用版本**: MVP V1.0
